# Realtime WS + Deterministic Booking + Seat Availability — 27/09/2025 21:59:51 WIB

## Scope
Implement **WebSocket realtime (5 events)**, make **booking deterministic**, fix **seat availability / multi-seat**, and show **seat availability on CSO "Available Trips"**.

### Key Features to Implement:
- WebSocket server with Socket.IO and rooms (`trip:<tripId>`, `base:<baseId>`, `cso:<outletId>:<serviceDate>`)
- 5 WebSocket events: TRIP_STATUS_CHANGED, TRIP_CANCELED, HOLDS_RELEASED, TRIP_MATERIALIZED, INVENTORY_UPDATED
- Deterministic booking with atomic operations and idempotency keys
- Multi-seat all-or-nothing booking
- Seat availability counts on CSO list for real and virtual trips

## Implementation Checklist

### A) WebSocket Realtime
- [ ] Install Socket.IO dependencies
- [ ] Create `server/realtime/ws.ts` with rooms and event helpers
- [ ] Implement all 5 events server-side emission:
  - [ ] TRIP_STATUS_CHANGED `{ tripId, status }`
  - [ ] TRIP_CANCELED `{ tripId }`
  - [ ] HOLDS_RELEASED `{ tripId, seatNos?: string[] }`
  - [ ] TRIP_MATERIALIZED `{ baseId, serviceDate, tripId }`
  - [ ] INVENTORY_UPDATED `{ tripId, seatNo: string, legIndexes?: number[] }`
- [ ] Add client-side WebSocket integration to React
- [ ] Implement client subscriptions for CSO list and seatmap pages
- [ ] Add fallback polling when WebSocket disconnected

### B) Deterministic Booking
- [ ] Make seat selection deterministic (sort by seat_no ASC)
- [ ] Fix leg range calculation: `[originSeq, destinationSeq - 1]`
- [ ] Implement atomic HOLD operations with SELECT FOR UPDATE
- [ ] Implement atomic BOOK/ISSUE operations 
- [ ] Add idempotency keys for booking attempts
- [ ] Add DEBUG logging for hold/book paths
- [ ] Create concurrency tests (5 parallel attempts → 1 success)

### C) Seat Availability & Multi-seat
- [ ] Fix multi-seat booking to be all-or-nothing
- [ ] Add seat counts to CSO "Available Trips"
- [ ] Implement real trip seat availability calculation
- [ ] Add estimated capacity for virtual trips
- [ ] Handle seat conflicts reporting for multi-seat

### D) Project Log
- [x] Create `replit_prompts/` folder
- [x] Create prompt log file with timestamp

## Files to Touch
- `server/realtime/ws.ts` (new)
- `server/modules/bookings/` (booking services)
- `server/modules/seatInventory/` (seat management)
- `server/modules/holds/` (hold management)
- `client/src/hooks/` (WebSocket hooks)
- `client/src/pages/cso/CsoPage.tsx` (seat counts display)
- Test files for concurrency testing

## Implementation Notes
*[To be filled during implementation]*

## Manual Test Results
*[To be filled during testing]*

## Follow-ups/TODOs
*[To be filled as needed]*